<!DOCTYPE html>
<html> 
<head>
    <title>Blank Cordova Mobile App Template</title>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=no">
    <style>
        @-ms-viewport { width: 100vw ; min-zoom: 100% ; zoom: 100% ; }          @viewport { width: 100vw ; min-zoom: 100% zoom: 100% ; }
        @-ms-viewport { user-zoom: fixed ; min-zoom: 100% ; }                   @viewport { user-zoom: fixed ; min-zoom: 100% ; }
    </style>
    
    <!--Librerias JQUERY MOBILE 1.4.5 -->
    <link rel="stylesheet" href="css/theme-konnen.min.css"/>
    <link rel="stylesheet" href="css/jquery.mobile.icons.min.css"/>
    <link rel="stylesheet" href="jquery.mobile-1.4.5/jquery.mobile.structure-1.4.5.min.css"/>
    <script type="text/javascript" src="js/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="jquery.mobile-1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script src="cordova.js"></script>
    <script src="js/js_funciones_mek.js"></script>
    <script src="js/app.js"></script>
    <script src="js/init-app.js"></script>
    <script src="xdk/init-dev.js"></script>
    <link rel="stylesheet" href="css/app.css">
    <link rel="stylesheet" href="estilosExpress.css">
    <script src="js/sweet.js"></script>
    <script src="js/funciones.js" type="text/javascript"></script>
    <script src="js/hilo.js"></script>
</head>
<body>
     
    <div id="page1" data-role="page" data-rnc-jspage="paintPage" data-theme="c">
        <div data-role="header" data-position='fixed'>
            <center><img src="imagenes/e-konnen.png" /></center>
            <a href="#panelM" class="ui-btn ui-icon-bars ui-btn-icon-notext ui-corner-all"></a>
            <a href="#" onclick="location.href='servicios.html';" class="ui-btn ui-icon-home ui-btn-icon-notext ui-corner-all"></a>
        </div>	
        
          <div data-role="content" class="ui-content">
            <div id="div_datos" style="display:none">
                <image id="theimage"></image>
                <textarea name="base64" id="base64"></textarea>
            </div>
              
            <span id="mnsEstado" style="color: #f36f32">Escanear Guia </span><span id="txtGuia" style="font-weiht:bold"></span>
            <button type="button" id="id_btnScan" data-icon="camera" data-iconpos="right" onclick="scan();" data-clear-btn="true">Escanear Guia</button>
            <input type="text" id="id_textArea" class="align-left" wrap="off" maxlength="20"  onkeypress="js_obtendatosExpress(event);" placeholder="Codigo de barras de la guia" data-clear-btn="true"/>
            
            <div style="height:200px;overflow: scroll; display:none;"><ul id="listaGuias" data-role="listview"  data-filter-plasheldor="Buscar..." data-inset="true"  data-divider-theme="a" >
                    <li style=" -webkit-border-bottom-left-radius: unset;
                    -webkit-border-bottom-right-radius: unset;" data-role="list-divider">Guias Capturadas <span style="float:right" ><span >Total:</span><span id="cantidadGuiasCapturadas"></span></span> </li>
            </ul></div>
            <br>
            <label id="lblservicio"><b>Guia:</b></label><!-- Modificacion 8 Oct 2019 Aldo -->
            <label id="lblempresa">Empresa:<br>-</label><!-- Modificacion 8 Oct 2019 Aldo -->
            <label id="lbldestino">Destino:<br>-</label><!-- Modificacion 8 Oct 2019 Aldo -->
            <input type="hidden" value="" id="hddServicio"/><!-- Modificacion 8 Oct 2019 Aldo -->
              
              
           <!--<a id="btnCamara" href='#popupDialog1'data-rel='popup' data-role='button' data-position-to='window' data-transition='pop' class=" ui-btn ui-shadow ui-corner-all  ui-btn-icon-left ui-btn-inline" style="width: 55px;
                              height: 53px;
                              border-radius: 100%;
                              background-color: #dbdbdb;
                              background-image: url(imagenes/camara.png);
                              background-repeat: no-repeat;
                              bottom:244.9px;
                              position: fixed;
                              font-size: 0px;
                              background-position-x: 50%;
                              background-position-y: 50%;
                              float: right!important;
                              right: 1;
                              right: 3%; 
                              display:none;
                             "></a>-->

            
            <div id="loading" style="display:none;">
                <input type="text" id="txtnumservicio" class="align-left" style="display:none;"/> 
                <input type="text" id="txtguia" class="align-left" style="display:none;"/> 
                <center>
                <img src="imagenes/loading4.gif" />
                </center>
            </div>  
              
              <!-- div para poder tomar la foto -->
               <div data-role="popup" id="popupDialog1" data-overlay-theme="a" data-theme="a" data-dismissible="true" style="max-width:450px;">
                <div data-role="header" data-theme="a">
                <h2>Evidencia</h2>
                </div>
                <div role="main" class="ui-content">                    
                    <img style="display:block;width:210px;height:190px;" id="smallImage" src="" />
                    <img style="display:none;" id="largeImage" src="" />
                    <input type="hidden" id="txtimgevidencia">               
                    <a href="#" data-theme="a" data-role="button" data-icon="check" onclick="capturePhoto();">Capturar Foto</a>           
                </div>
        </div>
              <!-- termina div para tomar la foto-->
              
        </div>
         <section id="content" data-role="content">  
             <div id="divInput" style="position: fixed; width: 90%; bottom: 120px;">
            <input type="text" id="txtnombrerecibe" maxlength="40" placeholder="Nombre de la persona que recolecta" data-clear-btn="true"/>
             </div>
            
<div data-role="popup" id="popupDialog" data-overlay-theme="b" data-theme="a" data-dismissible="false" style="max-width:400px;">
    <div data-role="header" data-theme="a">
    <h1>FIRMAR</h1>
    </div>
    <div role="main" class="ui-content" style=" margin-top: -49px;">
      
        <!-- PANEL DE LA FIRMA -->  
            <div class=" ui-body-d ui-corner-all">
                <center>
                    <canvas id="flexBox" style="background:white; border:1px solid #000000; display:block;    width: 100%;
                      height: 289px;"></canvas>
                    <div data-role="controlgroup" data-type="horizontal" data-mini="true">
                        <a href="#" onclick="js_limpiar_canvas_firma();" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">Limpiar</a>
                    </div>
                </center>
            </div>
            
               
	
    <p>Elija la acción que desee hacer</p>
        <a href="#" id="btnCancelar2" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Aceptar</a>
        <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back" data-transition="flow">Atras</a>
    </div>
</div>
        
 <a id="descargar" style="display:none">descarga</a>
            <br>
            <div class=" ui-body-d ui-corner-all" style="display:none">
                <center>
                    <canvas id="flexBox1" style="background:white; border:1px solid #000000; display:none;"></canvas>
                    <div data-role="controlgroup" data-type="horizontal" data-mini="true">
                        <a href="#" onclick="js_limpiar_canvas();" class="ui-btn ui-shadow ui-corner-all ui-icon-delete ui-btn-icon-left ui-btn-inline">Limpiar</a>
                    </div>
                </center>
            </div>
             <div id="este" >
             <center>
            <div data-role="controlgroup" data-type="horizontal" style="backgorund:red">
                <a href="#popupDialog" id="id_btnScanFirmaExpress" data-rel="popup" data-position-to="window" data-transition="pop" data-iconpos="right" id="id_btnScanFirmaExpress" data-clear-btn="true"   title="Ingresar firma"  > </a>
                <button  id="btnGuardarEntregarExpress" title="Registrar servicios"></button>
                
                <button  id="btnCancelarExpress" title="Cancelar servicios"></button>
            </div>
                 </center>
             </div>
		</section>
        <div data-role="popup" id="popupDialog" data-overlay-theme="a" data-theme="a" data-dismissible="true" style="max-width:450px;">
                <div data-role="header" data-theme="a">
                <h2>Evidencia</h2>
                </div>
                <div role="main" class="ui-content">                    
                    <img style="display:block;width:210px;height:190px;" id="smallImage" src="" />
                    <img style="display:none;" id="largeImage" src="" />
                    <input type="hidden" id="txtimgevidencia">               
                    <a href="#" data-theme="a" data-role="button" data-icon="check" onclick="capturePhoto();">Capturar Foto</a>           
                </div>
        </div>
        
        <div data-role="footer" data-position='fixed'>
            <h1>K&ouml;nnen MEK 2019</h1> 
        </div>
        
        <div id="panelM" data-role="panel" data-position="left" data-display="push" data-theme="d">  
            <ul data-role="listview" id="menuinicial" name="menuinicial">                                			  
                <!--<li><center>Usuario: <div id="nombreuser"></div></center></li>
                <li data-icon="bullets"><a href="#" onclick="location.href='servicios.html';">Mis Servicios</a></li>
                <li data-icon="bullets"><a href="#" onclick="location.href='menu_check.html';">Registro Movimientos</a></li>
                <li data-icon="info"><a href="#" onclick="location.href='menu_legal.html';">Legal</a></li>
                <li data-icon="lock"><a href="#" onclick="cerrarSession();">Cerrar Sesi&oacute;n</a></li> Cambio 25 oct 2019 Aldo -->
                <li>
                    <center>Usuario: <div id="nombreuser"></div></center>
                    <div data-role="control-group" data-mini="true">
                        <br>
                        <center>
                            <select name="flip_Estatus" id="flip_Estatus" data-role="flipswitch" data-theme="b" data-mini="true" onchange="evento_flipSwitchEstatus();">
                                <option value="off"></option>
                                <option value="on"></option>
                            </select>
                            <label id="lblEstatus" style="display: inline;">Disponible</label>
                        </center>
                    </div>
                </li>
                <li data-icon="bullets"><a href="#" onclick="location.href='servicios.html';">Inicio</a></li>
                <li data-icon="clock"><a href="#" onclick="location.href='historial_servicios.html';">Historial de Servicios</a></li>
                <li data-icon="bullets"><a href="#" onclick="location.href='menu_check.html';">Registro Movimientos</a></li>
                <li data-icon="info"><a href="#" onclick="location.href='menu_legal.html';">Legal</a></li>
	            <li data-icon="lock"><a href="#" onclick="cerrarSession();">Cerrar Sesi&oacute;n</a></li>
            </ul>    
        </div>
	</div>
</body>
</html>
<script>
   $(document).ready(function(){
        document.addEventListener("online",intervalo_hilo,false);
        $("#btnGuardarEntregarExpress").attr("disabled",true);
        var sEstatusSession = sessionStorage.getItem("estatusSession");//Pedimos el valor de la ultimo valor del estatus nombreuser        
        if(sEstatusSession == "1"){
            sessionStorage.setItem("entraAPagina", "1");
            $("#flip_Estatus").val("on").flipswitch("refresh");
        }else if(sEstatusSession == "0"){
            document.getElementById("lblEstatus").innerHTML = "No Disponible";
            $("#flip_Estatus").val("off").flipswitch("refresh");
        }
        
    });
</script>
<script src="js/paintPage.js" type="text/javascript"></script>
<script>
var RocknCoder = RocknCoder || {};
RocknCoder.Pages = RocknCoder.Pages || {};
(function () {
	"use strict";
	RocknCoder.PageEvents = "pagebeforeshow pageshow pagebeforechange pagechange pagebeforehide pagehide";
	RocknCoder.Pages.Kernel = function (event) {
		var that = this,
			eventType = event.type,
			pageName = $(this).attr("data-rnc-jspage");
		if (RocknCoder && RocknCoder.Pages && pageName && RocknCoder.Pages[pageName] && RocknCoder.Pages[pageName][eventType]) {
			RocknCoder.Pages[pageName][eventType].call(that);
		}
	};

	(function () {
		$("div[data-rnc-jspage]").on(
			RocknCoder.PageEvents,
			RocknCoder.Pages.Kernel
		);
	}());

	(function () {
		$(document).bind(
			'pageload',
			function (event, obj) {
				console.log("pageload");
				$("div[data-rnc-jspage]")
					// to make sure we aren't double hooking events clear them all
					.off(RocknCoder.PageEvents)
					// then hook them all  (the newly loaded page is in DOM at this point)
					.on(RocknCoder.PageEvents, RocknCoder.Pages.Kernel);
			}
		);
	}());

	RocknCoder.Dimensions = (function () {
		var get = function () {
			var isFirstPass = false,
				isIPhone = (/iphone/gi).test(navigator.appVersion),
				width = $(window).width(),
				height = $(window).height() + (isIPhone ?  60 : 0),
				hHeight = $('header').outerHeight(),
				fHeight = $('footer').outerHeight();
			return {
				width: width,
				height: height - hHeight - fHeight
			};
		};
		return {
			get: get
		};
	}());
}());
    
function abrirfirma(){
    var idmov=document.getElementById("txtnumservicio").value;
    var personsarecibe=document.getElementById("txtnombrerecibe").value;
    if(idmov==""){
      navigator.notification.alert('No existe información de la guia, favor de validar los datos.',function(){
          document.getElementById("id_textArea").focus();
      },'Error','Aceptar');  
    }else if(personsarecibe==""){
        navigator.notification.alert('Debe colocar el nombre de la persona que recibe',function(){
          document.getElementById("txtnombrerecibe").focus();
      },'Error','Aceptar'); 
    }else{
        document.getElementById("flexBox").style.display="block";    
    }
    
}  

/*Funcion que limpia el panel de firma y los componentes de la imagen de la evidencia*/
function js_limpiar_canvas(){
    var canvas = document.getElementById("flexBox");
    canvas.width=canvas.width;          
    document.getElementById("theimage").src = null;
    document.getElementById("smallImage").src = "";
    document.getElementById("largeImage").src = "";
    document.getElementById("txtimgevidencia").value = "";
    
}   
    
/*Función para que no limpie los componentes de la imagen de la evidencia*/    
function js_limpiar_canvas_firma(){
    var canvas = document.getElementById("flexBox");
    canvas.width=canvas.width;  
}

function limpiarTodo(){
    var canvas = document.getElementById("flexBox");
    canvas.width=canvas.width;          
    document.getElementById("theimage").src = null;
    document.getElementById("txtnombrerecibe").value = "";
    document.getElementById("id_textArea").value = "";    
    document.getElementById("txtguia").value="";
    document.getElementById("txtnumservicio").value="";
    document.getElementById("lblservicio").innerHTML="<b>Guia:</b> ";
    document.getElementById("lbldestino").innerHTML="Destino:";
    document.getElementById("lblempresa").innerHTML="Empresa:";
    document.getElementById('base64').value = "";
    document.getElementById('smallImage').src="";
    location.href='servicios.html';
}              
    
function limpiarTodoCampos(){
    var canvas = document.getElementById("flexBox");
    canvas.width=canvas.width;          
    document.getElementById("theimage").src = "";
    document.getElementById("txtnombrerecibe").value = "";
    document.getElementById("id_textArea").value = "";    
    document.getElementById("txtguia").value="";
    document.getElementById("txtnumservicio").value="";
    document.getElementById("lblservicio").innerHTML="<b>Guia:</b> ";
    document.getElementById("lbldestino").innerHTML="Destino:";
    document.getElementById("lblempresa").innerHTML="Empresa:";
    document.getElementById('base64').value = "";
    document.getElementById('smallImage').src="";
} 

function js_guardar_canvas(){
  var urlconex = sessionStorage.getItem("urlconex");
  var idmov=document.getElementById("txtnumservicio").value;
  var txtimgevidencia=document.getElementById("txtimgevidencia").value;
  if(txtimgevidencia==""){
  }    else{
  }
  
  var nombrerecibe=document.getElementById("txtnombrerecibe").value.trim();
  if(idmov==""){
      navigator.notification.alert('No ha escaneado el codigo de barras de la guia',function(){
          document.getElementById("id_textArea").focus();
      },'Error','Aceptar');  
  }else if(nombrerecibe==""){      
      navigator.notification.alert('No ha capturado el nombre de la persona que recibe',function(){
          document.getElementById("txtnombrerecibe").focus();
      },'Error','Aceptar');  
  }else{
      var canvas = document.getElementById("flexBox");  
      var image = canvas.toDataURL();   
      document.getElementById("theimage").src = image;
      document.getElementById('base64').value = image;
      
      var numbertrack=document.getElementById("txtguia").value;  
      habilitarloading();
      
      $.ajax({
		type : "POST",
        data:{
            idmov: idmov,
            nombrerecibio:nombrerecibe,
            firma:image,
            numbertrack:numbertrack,
            evidencia:txtimgevidencia
        },
		url : urlconex+"registro_entrega.php",		        
		error : function() {
            inabilitarloading();
			navigator.notification.alert('Error con conexion al servidor',function(){},'Error','Aceptar');
		},
        success: function(data) {            
            var datos=data.trim();
            var exito="\"OK\"";
            if(datos==exito){
                navigator.notification.alert('Se registro correctamente la entrega',function(){
                     js_limpiar_canvas();  
                     location.href="servicios.html";    
                },'OK','Aceptar'); 
            }else{
                navigator.notification.alert('No se guardaron los datos',function(){},'Error','Aceptar');      
            }            
            inabilitarloading();            
        }
	});
  }  
}
    
function scan() {
    "use strict";
    var fName = "scan():";
    console.log(fName, "entry");
    try {
        if (window.tinyHippos) {
            thirdPartyEmulator();
            console.log(fName, "emulator alert");
        } else {
            cordova.plugins.barcodeScanner.scan(
                function (result) {
                    document.getElementById("id_textArea").value=result.text+"";
                    console.log(fName, "Scanned result found!");
                    //agregarFilaAlaLista();
                    //obtener_datosExpress();//Modificacion 8 Oct 2019 Aldo                    
                    if(document.getElementById("id_textArea").value != ""){
                        verificar_guiaEntrega();
                    }
                },
                function (error) {
                    navigator.notification.alert('Scanning failed: '+error,function(){},'Error','Aceptar');
                }
            );
        }
    } catch (e) {
        console.log(fName, "catch, failure");
    }
    console.log(fName, "exit");
}
    
function js_obtendatos(e){
    if (e.keyCode == 13) {
     agregarFilaAlaLista(); 
    }
}    
    
function obtener_datos(){
    var urlconex = sessionStorage.getItem("urlconex");
    var Tracknumber = document.getElementById("id_textArea").value;
    if(Tracknumber!=""){
        var dataString="Tracknumber="+Tracknumber+"";  
        habilitarloading();
        $.ajax({
            type : "GET",
            url : urlconex+"consulta_check.php?"+dataString,		        
            error : function() {
                inabilitarloading();
                limpiarTodoCampos();
                navigator.notification.alert('Error con conexion al servidor',function(){},'Error','Aceptar');
            },
            success: function(data) { 
                var errorserv=data;
                errorserv=errorserv.trim();
                var erro="\"Error\"";   
                var erro2="\"Guia Finalizada\"";   
                if(errorserv==erro){
                    inabilitarloading();
                    limpiarTodoCampos();
                    navigator.notification.alert('No se encontro el servicio favor de validarlo.',function(){},'Error','Aceptar');
                }else if(errorserv==erro2){
                    inabilitarloading();
                    limpiarTodoCampos();
                    navigator.notification.alert('La guia ya ha sido entregada.',function(){},'Alerta','Aceptar');
                }else{
                    inabilitarloading();
                    var obj = JSON.parse(data);                       
                    var numserv=obj.servicios_generados.length;                       
                    for(var i=0;i<numserv;i++){
                        var idmov=obj.servicios_generados[i].IdMov;
                        var cdorigen=obj.servicios_generados[i].cdorigen;                
                        var estaorigen=obj.servicios_generados[i].estaorigen;                
                        var cddestino=obj.servicios_generados[i].cddestino;                
                        var estadestino=obj.servicios_generados[i].estadestino; 
                        var calledestino=obj.servicios_generados[i].calledestino; 
                        var coloniadestino=obj.servicios_generados[i].coloniadestino; 
                        var noextdestino=obj.servicios_generados[i].noextdestino; 

                        var Tracknumber=obj.servicios_generados[i].Tracknumber; 
                        var razon_social=obj.servicios_generados[i].razon_social;  
                        
                        document.getElementById("txtnumservicio").value=idmov;
                        document.getElementById("txtguia").value=Tracknumber;
                        document.getElementById("lblservicio").innerHTML="<b>Guia:</b> "+Tracknumber;
                        document.getElementById("lbldestino").innerHTML="Destino: "+calledestino+" #"+noextdestino+" "+coloniadestino+" "+cddestino;
                        document.getElementById("lblempresa").innerHTML="Empresa: "+razon_social;
                    }                                     
                }
                inabilitarloading();
                document.getElementById("id_textArea").value="";              
            }
        });
    }    
}   
    
var servicio = sessionStorage.getItem("servicioselecionado");
if(servicio!=""){
    document.getElementById("id_textArea").value=servicio;     
     obtener_datos();
     inabilitarloading();
}       
</script>

<script type="text/javascript" charset="utf-8">
    var pictureSource;
    var destinationType;
    
    document.addEventListener("deviceready",onDeviceReady,false);
    
    function onDeviceReady() {
        pictureSource=navigator.camera.PictureSourceType;
        destinationType=navigator.camera.DestinationType;
    }
    
    function onPhotoDataSuccess(imageData) {
        var smallImage = document.getElementById('smallImage');
        smallImage.style.display = 'block';
        document.getElementById('txtimgevidencia').value=imageData;
        smallImage.src = "data:image/jpeg;base64," + imageData;
    }
    
    function onPhotoURISuccess(imageURI) {
        var largeImage = document.getElementById('largeImage');
        largeImage.style.display = 'block';
        largeImage.src = imageURI;
    }
    
    function capturePhoto() {
        pictureSource=navigator.camera.PictureSourceType;
        destinationType=navigator.camera.DestinationType;
        navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 65,
        destinationType: destinationType.DATA_URL, targetWidth:800, targetHeight:800 });
    }
    
    function capturePhotoEdit() {
      navigator.camera.getPicture(onPhotoDataSuccess, onFail, { quality: 20, allowEdit: true,
        destinationType: destinationType.DATA_URL });
    }

    function getPhoto(source) {
      navigator.camera.getPicture(onPhotoURISuccess, onFail, { quality: 50,
        destinationType: destinationType.FILE_URI,
        targetWidth: 500,
        targetHeight: 500,
        sourceType: source });
    }
    
    function onFail(message) {
      alert('Failed because: ' + message);
    }
    
    function mostrarInfo(){
        var la=  sessionStorage.getItem("latitud");
        var lo=sessionStorage.getItem("longitud");
        alert("valores la " + la + " long " + lo);
    }    
</script>

<script src="http://hongru.github.io/proj/canvas2image/canvas2image.js"></script>//para guardar canvas en imagen
<script>
    var nombreusuario = sessionStorage.getItem("nombreuser");   
    document.getElementById("nombreuser").innerHTML=""+nombreusuario;
    inabilitarloading();
</script>



/* ---------------------------------------------------------------------------------- */
<script>//Funciones nuevas Aldo
    function js_obtendatosExpress(e){
    if (e.keyCode == 13) {
      //obtener_datosExpress();   
      verificar_guiaEntrega();
    }
}    
    
var verificacionTracknumber = 0;
    
function verificar_guiaEntrega(){
   var Tracknumber = document.getElementById("id_textArea").value;
   var tracknumberSeleccionado = sessionStorage.getItem("servicioselecionado");
   if(Tracknumber===tracknumberSeleccionado){
        //habilita el boton de guardar y muestra mensaje de exito
        $("#btnGuardarEntregarExpress").attr("disabled",false);
       $("#id_textArea").attr("readonly",true);
        obtener_datosExpress();
        verificacionTracknumber = 1;
        $("#id_btnScan").attr("disabled",true);
        $("#mnsEstado").css({'visibility':'hidden',});
        swal("Exito!", "Guia escaneada correctamente", "success"); 
   }else{
       //muestra el mensaje de error
       swal("Advertencia!", "Guia escaneada incorrecta", "warning"); 
       $("#btnGuardarEntregarExpress").attr("disabled",true);
   }
} 
    
function obtener_datosExpress(){
    var urlconex = sessionStorage.getItem("urlconex");
    var Tracknumber = document.getElementById("id_textArea").value;    
    if(Tracknumber!=""){
        var dataString="Tracknumber="+Tracknumber+"";  
        habilitarloading();        
        $.ajax({
            type : "GET",
            url : urlconex+"consulta_check.php?"+dataString,		        
            error : function() {
                inabilitarloading();
                limpiarTodoCampos();
                navigator.notification.alert('Error con conexion al servidor',function(){},'Error','Aceptar');
            },
            success: function(data) {
                var obJson = JSON.parse(data);                
                var mensaje = data;
                if(obJson == "Error" || obJson == "Guia Finalizada"){
                    mensaje = obJson;
                }
                mensaje = mensaje.trim();
                if(mensaje == "Error"){
                    limpiarTodoCamposExpress();
                    inabilitarloading();                
                    navigator.notification.alert('No se encontro el servicio favor de validarlo.',function(){},'Error','Aceptar');
                }else if(mensaje == "Guia Finalizada"){
                    inabilitarloading();
                    limpiarTodoCamposExpress();
                    navigator.notification.alert('La guia ya ha sido entregada.',function(){},'Alerta','Aceptar');
                }else{
                    inabilitarloading();
                    var obj = JSON.parse(data);                       
                    var numserv=obj.servicios_generados.length;                       
                    for(var i=0;i<numserv;i++){
                        var idmov=obj.servicios_generados[i].IdMov;
                        var cdorigen=obj.servicios_generados[i].cdorigen;                
                        var estaorigen=obj.servicios_generados[i].estaorigen;                
                        var cddestino=obj.servicios_generados[i].cddestino;                
                        var estadestino=obj.servicios_generados[i].estadestino; 
                        var calledestino=obj.servicios_generados[i].calledestino; 
                        var coloniadestino=obj.servicios_generados[i].coloniadestino; 
                        var noextdestino=obj.servicios_generados[i].noextdestino; 
                        var Tracknumber=obj.servicios_generados[i].Tracknumber; 
                        var razon_social=obj.servicios_generados[i].razon_social;       
                        
                        $("#btnCamara").css("display", "block");
                        document.getElementById("hddServicio").value = Tracknumber;//Aldo 8 oct 2019
                        document.getElementById("txtnumservicio").value=idmov;
                        document.getElementById("txtguia").value=Tracknumber;
                        document.getElementById("lblservicio").innerHTML="<b>Guia:</b> "+Tracknumber;
                        document.getElementById("lbldestino").innerHTML="Destino: "+calledestino+" #"+noextdestino+" "+coloniadestino+" "+cddestino;
                        document.getElementById("lblempresa").innerHTML="Empresa: "+razon_social;
                    }                                     
                }
                inabilitarloading();
                document.getElementById("id_textArea").value="";              
            }
        });
    }    
}   
    
var servicio = sessionStorage.getItem("servicioselecionado");
if(servicio!=""){
    document.getElementById("id_textArea").value=servicio;     
    obtener_datosExpress();
    inabilitarloading();
}
    
function limpiarTodoCamposExpress(){
     $("#btnCamara").css("display", "none");
    document.getElementById("hddServicio").value = "";
    var canvas = document.getElementById("flexBox");
    canvas.width=canvas.width;          
    document.getElementById("theimage").src = "";
    document.getElementById("txtnombrerecibe").value = "";
    document.getElementById("id_textArea").value = "";    
    document.getElementById("txtguia").value="";
    document.getElementById("txtnumservicio").value="";
    document.getElementById("lblservicio").innerHTML="<b>Guia:</b> ";
    document.getElementById("lbldestino").innerHTML="Destino:";
    document.getElementById("lblempresa").innerHTML="Empresa:";
    document.getElementById('base64').value = "";
    document.getElementById('smallImage').src="";
}
    
$("#btnGuardarEntregarExpress").click(function () {
    habilitarloading();
    var guia = document.getElementById("hddServicio").value;
    if(verificacionTracknumber!=1){
        swal("Advertecia!","No se ha escaneado la guia", "warning");
        verificacionTracknumber=0;
    }else if (guia != "") {
        var valorQuienRecibe = $("#txtnombrerecibe").val();
        if (valorQuienRecibe.length > 0) {
            var canvas = document.getElementById("flexBox");
            var image = canvas.toDataURL(); 
            var urlconex = sessionStorage.getItem("urlconex");
            var latitud = sessionStorage.getItem("latitud");
            var longitud = sessionStorage.getItem("longitud");
            var idUsuarioInicioSesion = sessionStorage.getItem("idusuario");
            
            $.ajax({
                type: "POST",
                url: urlconex + "cambiar_estatus_servicio2.php",
                data: {tracknumber: guia,
                        valorQuienRecibe: valorQuienRecibe,
                        image: image,
                        idUsuario: idUsuarioInicioSesion,
                        latitud: latitud,
                        longitud: longitud
                      },
                error: function () {
                    inabilitarloading();
                    swal("Advertecia!", "Sin conexión al servidor los datos se almacenaron localmente", "warning");   
                    var bdr = crearBDRecoleccion();
                    crearTableRecoleccion(bdr); registrarDatosRecoleccion(bdr,guia,"ZZM03",valorQuienRecibe,image,idUsuarioInicioSesion,idUsuarioInicioSesion);
                    /*js_limpiar_canvas();
                    //vaciarLista();
                    contadorGuiasCapturadas = 0;
                    $("#id_textArea").val('');
                    $("#txtnombrerecibe").val('');
                    //$("#cantidadGuiasCapturadas").html(contadorGuiasCapturadas);
                    $("#btnCamara").css("display", "none");
                    $("#btnCamara").css("border-color", "#dbdbdb");
                    $("#id_btnScan").attr("disabled", false);
                    $("#id_textArea").attr("disabled", false);
                    document.getElementById("txtimgevidencia").value = "";
                    document.getElementById('smallImage').src = "";
                    var canvas = document.getElementById("flexBox");
                    canvas.width = canvas.width;
                    document.getElementById("theimage").src = null;
                    document.getElementById("largeImage").src = "";
                    $("#btnGuardarEntregarExpress").attr("disabled", false);
                    intervalo();*/
                    setTimeout(function(){
                        location.href = "servicios.html"; 
                    }, 2000);        
                }, success: function (resultado) {
                    inabilitarloading();
                    swal("Exito!","Se registro correctamente el CheckPoint", "success");
                    var latini = sessionStorage.getItem("latitud");
                    var longini = sessionStorage.getItem("longitud");
                    setTimeout( function() {
                        location.href="servicios.html";        
                    }, 2000);
                }
            });
        } else {
            inabilitarloading();
            $("#txtnombrerecibe").focus();
            swal("Advertecia!", "Debe colocar el nombre de la persona que recolecta", "warning");
            $("#txtnombrerecibe").focus();
        }
    }

});
    
    
/****************************************** BD LOCAL ***********************************/
     function crearBDRecoleccion(){
        var bdr=window.openDatabase('mydb7','1.0','testdb7',2*1024*1024);
        return bdr;
     }
    
    function crearTableRecoleccion(bdr){
        bdr.transaction(function(texto){
            texto.executeSql('create table if not exists seguimientoRutaExpress (tracknumber,checkPoint,tipoEvidencia,firma,usuarioCreacion,idUsuarioCreacion,fecha)');
        });
    }
    
    function registrarDatosRecoleccion(bdr,guia,chekPoint,valorQuienRecibe,image,nombreUsuarioInicioSesion,idUsuarioInicioSesion){
        var fecha=obtenerFechaYhoraRecoleccion();
        bdr.transaction(function(texto){
            texto.executeSql('insert into seguimientoRutaExpress (tracknumber,checkPoint,tipoEvidencia,firma,usuarioCreacion,idUsuarioCreacion,fecha) values ("'+guia+'","'+chekPoint+'","'+valorQuienRecibe+'","'+image+'","'+nombreUsuarioInicioSesion+'","'+idUsuarioInicioSesion+'","'+fecha+'")');
        }); 
    }
    
    function obtenerFechaYhoraRecoleccion(){
        var hoy= new Date();
        var mesBien=(hoy.getMonth()+1);
        var diaBien= hoy.getDate();
        var minutosBien= hoy.getMinutes();
        var horaBien=hoy.getHours();
        var segundoBien= hoy.getSeconds();

        if((hoy.getMonth()+1) <10 ){
            mesBien='0'+(hoy.getMonth()+1);
        }else{  
        }
        if(hoy.getDate() <10 ){
            diaBien='0'+ hoy.getDate();
        }else{
        } 
        if(hoy.getHours() <10 ){
          horaBien='0'+ hoy.getHours();
        }else{   
        } 
        if(hoy.getMinutes() <10 ){
           minutosBien='0'+hoy.getMinutes();
        }else{   
        } 
        if(hoy.getSeconds() <10 ){
            segundoBien='0'+ hoy.getSeconds();
        }else{ 
        } 

        var fecha=hoy.getFullYear()+"-"+mesBien+"-"+ diaBien;
        var hora=horaBien+":"+minutosBien+":"+segundoBien;
        var enviarFecha=fecha+" "+hora;

        return enviarFecha;
    }
/***************************************************************************************/
    
    /*$("#btnGuardarEntregarExpress").click(function () {
        var guia = document.getElementById("hddServicio").value;
        if(verificacionTracknumber!=1){
            swal("Advertecia!","No se ha escaneado la guia", "warning"); 
            verificacionTracknumber=0;
        }else if (guia != "") {
            var valorQuienRecibe = $("#txtnombrerecibe").val();
            if (valorQuienRecibe.length > 0) {
                $("#btnGuardarEntregarExpress").css("disabled", true);
                var canvas = document.getElementById("flexBox");
                var image = canvas.toDataURL(); 
                var img1 = document.getElementById("theimage").src = image;
                var img2 = document.getElementById('base64').value = image;
                var img = document.getElementById('base64').value;                                
                var txtimgevidencia = document.getElementById("txtimgevidencia").value;
                if (txtimgevidencia != '') {
                    $("#btnGuardarEntregarExpress").attr("disabled", true);
                    //concatenarDatosEntregar(valorQuienRecibe, image, txtimgevidencia);
                    enviarDatosEntregaExpress(guia, valorQuienRecibe, image, txtimgevidencia);
                } else {
                    swal("Advertecia!", "Debe tomar una foto de evidencia", "warning");
                    $("#btnCamara").focus();
                    $("#btnCamara").css("border-color", "red");
                }                
            } else {
                $("#txtnombrerecibe").focus();
                swal("Advertecia!", "Debe colocar el nombre de la persona que recibe", "warning");
                $("#txtnombrerecibe").focus();
            }
        } else {
            swal("Advertecia!", "Necesita capturar al menos una guia", "warning");

        }

    });*/


    $("#id_btnScanFirmaExpress").click(function () {
    var guia = document.getElementById("hddServicio").value;
    if (guia != "") {
        var valorQuienRecibe = $("#txtnombrerecibe").val();
        if (valorQuienRecibe.length > 0) {
        } else {
            $("#txtnombrerecibe").focus();
            swal("Advertecia!", "Debe colocar el nombre de la persona que recolecta", "warning");
            document.location = $("#btnCancelar2").attr("href");
            $("#txtnombrerecibe").focus();
        }
    } else {
        swal("Advertecia!", "Necesita capturar al menos una guia", "warning");
        document.location = $("#btnCancelar2").attr("href");
    }
    });
    
    $("#btnCancelarExpress").click(function () {
        var canvas = document.getElementById("flexBox");
        canvas.width = canvas.width;
        document.getElementById("theimage").src = null;
        document.getElementById("txtnombrerecibe").value = "";
        document.getElementById("id_textArea").value = "";
        document.getElementById("txtnumservicio").value = "";
        document.getElementById("txtnombrerecibe").value = "";
        document.getElementById('base64').value = "";
        removerLista();
        location.href = 'servicios.html';
    });
    
    /*function enviarDatosEntregaExpress(tracknumber, valorQuienRecibe, image, txtimgevidencia) {
        habilitarloading();
        var latitud1 = sessionStorage.getItem("latitud");
        var longitud1 = sessionStorage.getItem("longitud");
        var idUsuarioInicioSesion = sessionStorage.getItem("idusuario");
        var nombreUsuarioInicioSesion = sessionStorage.getItem("nombreuser");        
        $.ajax({
            type: "POST",
            url: ip + "registro_entrega1.php",
            data: {tracknumber: tracknumber,
                valorQuienRecibe: valorQuienRecibe,
                image: image,
                nombreUsuarioInicioSesion: nombreUsuarioInicioSesion,
                latitud: latitud1,
                longitud: longitud1,
                txtimgevidencia: txtimgevidencia},
            error: function () {
                inabilitarloading();
                swal("Advertecia!", "Sin conexión al servidor los datos se almacenaron localmente", "warning");   
                var bd = crearBD();
                crearTable(bd);
                registrarDatos(bd, tracknumber, valorQuienRecibe, image, nombreUsuarioInicioSesion, txtimgevidencia);
                js_limpiar_canvas();
                //vaciarLista();
                contadorGuiasCapturadas = 0;
                $("#id_textArea").val('');
                $("#txtnombrerecibe").val('');
                //$("#cantidadGuiasCapturadas").html(contadorGuiasCapturadas);
                $("#btnCamara").css("display", "none");
                $("#btnCamara").css("border-color", "#dbdbdb");
                $("#id_btnScan").attr("disabled", false);
                $("#id_textArea").attr("disabled", false);
                document.getElementById("txtimgevidencia").value = "";
                document.getElementById('smallImage').src = "";
                var canvas = document.getElementById("flexBox");
                canvas.width = canvas.width;
                document.getElementById("theimage").src = null;
                document.getElementById("largeImage").src = "";
                $("#btnGuardarEntregarExpress").attr("disabled", false);
                intervalo();
                setTimeout(function(){
                    location.href = "servicios.html"; 
                    }, 7000);                
            }, success: function (resultado) {

                inabilitarloading();

                var datos = resultado.trim();
                var exito = 'true';
                var ban1 =datos.indexOf("Entregas");
                if(ban1 > -1){
                    swal(datos);
                    setTimeout(function(){
                        location.href = "servicios.html"; 
                    }, 7000);

                }else{
                    swal("Advertencia!", "Error en la conexión", "warning");
                }
                inabilitarloading();
            }
        });
    }*/

</script>